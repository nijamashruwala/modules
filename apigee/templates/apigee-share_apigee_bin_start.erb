#!/bin/bash

if [ `echo $0 | grep "^/"` ]; then
    export working_dir=`dirname $0`
else
    export working_dir=`pwd`/`dirname $0`
fi
profile="${1:10}" # extract profile from -D option

source $working_dir/lib.sh

check_jvm
create_classpath

if [ $max_open_files ]; then
    ulimit -n $max_open_files
fi

create_jvm_argslist

# Launching java
<%-if @role.match(/mp|router|mgmt/)-%>
#nohup $JAVA -classpath "$classpath" -Xms$min_mem -Xmx$max_mem -XX:MaxPermSize=$max_permsize -Dcom.sun.management.jmxremote -Dinstallation.dir=$install_dir $sys_props -Dconf.dir=$conf_path -Ddata.dir=$data_dir $* com.apigee.kernel.MicroKernel &
nohup $JAVA -classpath "$classpath" -server  -Xms3g -Xmx3g -XX:PermSize=800m -XX:MaxPermSize=800m -XX:NewSize=1g -XX:MaxNewSize=1g -XX:SurvivorRatio=8 -XX:+DisableExplicitGC -verbose:gc -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+CMSClassUnloadingEnabled -XX:+UseConcMarkSweepGC -XX:-UseBiasedLocking -XX:ParallelGCThreads=12 -XX:LargePageSizeInBytes=128m -Dcom.sun.management.jmxremote -Dinstallation.dir=$install_dir $sys_props -Dconf.dir=$conf_path -Ddata.dir=$data_dir $* com.apigee.kernel.MicroKernel &
<%-else-%>
nohup $JAVA -classpath "$classpath" -Xms$min_mem -Xmx$max_mem -XX:MaxPermSize=$max_permsize -Dcom.sun.management.jmxremote -Dinstallation.dir=$install_dir $sys_props -Dconf.dir=$conf_path -Ddata.dir=$data_dir $* com.apigee.kernel.MicroKernel &
<%-end-%>
